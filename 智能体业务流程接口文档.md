# 智能体业务流程接口文档

## 概述

本文档描述了智能体系统的完整业务流程，从前端创建会话开始，到面试评估的整个过程。

## 业务流程图

```
前端启动 → 创建会话 → AI聊天交互 → 抽取面试题 → 用户答题 → 评分计算 → 雷达图展示
```

## 详细接口流程

### 1. 会话创建阶段

#### 1.1 创建Agent会话
**接口**: `POST /api/xunzhi/v1/agents/sessions`

**使用场景**: 前端用户进入智能体页面时，需要先创建一个会话来开始对话

**请求参数**:
```json
{
  "title": "面试准备会话",
  "agentId": "agent_001"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "sessionId": "session_12345",
    "title": "面试准备会话",
    "createTime": "2024-01-01T10:00:00"
  }
}
```

### 2. AI聊天交互阶段

#### 2.1 Agent聊天接口
**接口**: `POST /api/xunzhi/v1/agents/sessions/{sessionId}/chat`

**使用场景**: 用户与AI进行对话交流，了解面试相关信息

**请求参数**:
```json
{
  "message": "你好，我想准备Java开发工程师的面试",
  "messageType": "TEXT"
}
```

**响应**: SSE流式响应
```
data: {"type":"message","content":"你好！我是你的面试助手..."}
data: {"type":"complete","sessionId":"session_12345"}
```

### 3. 面试题抽取阶段

#### 3.1 抽取面试题
**接口**: `POST /api/xunzhi/v1/agents/sessions/{sessionId}/interview-questions`

**使用场景**: 当AI判断用户准备充分后，系统自动抽取相关面试题

**请求参数**:
```json
{
  "questionCount": 5,
  "difficulty": "MEDIUM",
  "category": "JAVA_DEVELOPMENT"
}
```

**响应**: SSE流式响应
```
data: {"type":"question","content":"请介绍一下Java的多态性"}
data: {"type":"question","content":"什么是Spring Boot的自动配置"}
data: {"type":"complete","questionCount":5}
```

#### 3.2 获取用户面试题列表
**接口**: `GET /api/xunzhi/v1/agents/interview/questions`

**使用场景**: 前端展示已抽取的面试题列表

**响应**:
```json
{
  "code": 200,
  "data": {
    "question1": "请介绍一下Java的多态性",
    "question2": "什么是Spring Boot的自动配置",
    "question3": "如何优化SQL查询性能",
    "question4": "描述一下微服务架构的优缺点",
    "question5": "什么是Redis的持久化机制"
  }
}
```

### 4. 用户答题阶段

#### 4.1 提交面试题答案
**接口**: `POST /api/xunzhi/v1/agents/interview/answer`

**使用场景**: 用户回答面试题后提交答案进行评分

**请求参数**:
```json
{
  "questionId": "question1",
  "answer": "Java的多态性是指同一个接口可以有多种不同的实现方式...",
  "answerTime": 120,
  "audioFile": "base64_audio_data"
}
```

**响应**:
```json
{
  "code": 200,
  "data": {
    "score": 85,
    "feedback": "回答较为完整，但可以补充更多实际应用场景",
    "keyPoints": ["继承", "重写", "接口实现"],
    "suggestions": "建议深入学习设计模式中的多态应用"
  }
}
```

### 5. 评分与数据获取阶段

#### 5.1 获取面试总分
**接口**: `GET /api/xunzhi/v1/agents/interview/score`

**使用场景**: 展示用户当前面试的总体得分

**响应**:
```json
{
  "code": 200,
  "data": 82
}
```

#### 5.2 获取简历评分
**接口**: `GET /api/xunzhi/v1/agents/resume/score`

**使用场景**: 展示基于简历分析的评分

**响应**:
```json
{
  "code": 200,
  "data": 78
}
```

#### 5.3 获取神态评分
**接口**: `GET /api/xunzhi/v1/agents/demeanor/score`

**使用场景**: 展示基于表情识别的神态管理评分

**响应**:
```json
{
  "code": 200,
  "data": 75
}
```

### 6. 雷达图数据展示阶段

#### 6.1 获取雷达图数据
**接口**: `GET /api/xunzhi/v1/agents/radar-chart`

**使用场景**: 前端展示用户综合能力雷达图

**响应**:
```json
{
  "code": 200,
  "data": {
    "resumeScore": 0.78,
    "interviewPerformance": 0.82,
    "demeanorEvaluation": 0.75,
    "professionalSkills": 0.80,
    "potentialIndex": 0.79
  }
}
```

#### 6.2 获取面试建议
**接口**: `GET /api/xunzhi/v1/agents/interview/suggestions`

**使用场景**: 为用户提供个性化的面试改进建议

**响应**:
```json
{
  "code": 200,
  "data": {
    "技术能力": "建议加强Spring框架的深入理解",
    "表达能力": "回答时可以更加简洁明了",
    "项目经验": "可以准备更多实际项目案例",
    "综合建议": "整体表现良好，继续保持学习热情"
  }
}
```

### 7. 会话管理

#### 7.1 查询会话历史
**接口**: `GET /api/xunzhi/v1/agents/conversations/{sessionId}/messages`

**使用场景**: 查看特定会话的聊天记录

#### 7.2 结束会话
**接口**: `PUT /api/xunzhi/v1/agents/conversations/{sessionId}/end`

**使用场景**: 用户完成面试后结束当前会话

## 完整业务流程示例

### 前端调用时序

1. **页面初始化**
   ```javascript
   // 创建会话
   const session = await createSession({
     title: "Java开发面试准备",
     agentId: "java_interview_agent"
   });
   const sessionId = session.data.sessionId;
   ```

2. **用户聊天交互**
   ```javascript
   // 建立SSE连接进行聊天
   const chatStream = new EventSource(`/api/xunzhi/v1/agents/sessions/${sessionId}/chat`);
   chatStream.onmessage = (event) => {
     const data = JSON.parse(event.data);
     displayMessage(data.content);
   };
   ```

3. **抽取面试题**
   ```javascript
   // 当AI建议开始面试时，抽取题目
   const questionStream = new EventSource(`/api/xunzhi/v1/agents/sessions/${sessionId}/interview-questions`);
   questionStream.onmessage = (event) => {
     const data = JSON.parse(event.data);
     if (data.type === 'question') {
       addQuestionToList(data.content);
     }
   };
   ```

4. **用户答题**
   ```javascript
   // 用户回答每道题目
   const result = await submitAnswer({
     questionId: 'question1',
     answer: userAnswer,
     answerTime: timeSpent
   });
   displayScore(result.data.score);
   ```

5. **展示综合评估**
   ```javascript
   // 获取各项评分
   const [totalScore, resumeScore, demeanorScore, radarData] = await Promise.all([
     getTotalScore(),
     getResumeScore(), 
     getDemeanorScore(),
     getRadarChartData()
   ]);
   
   // 渲染雷达图
   renderRadarChart(radarData.data);
   ```

## 错误处理

### 常见错误码

- `400`: 请求参数错误
- `401`: 用户未登录
- `403`: 权限不足
- `404`: 会话不存在
- `500`: 服务器内部错误

### 错误响应格式
```json
{
  "code": 400,
  "message": "参数错误：sessionId不能为空",
  "data": null
}
```

## 注意事项

1. **会话状态管理**: 前端需要妥善保存sessionId，用于后续所有接口调用
2. **SSE连接**: 聊天和抽题接口使用SSE流式响应，需要正确处理连接和断开
3. **权限验证**: 所有接口都需要在请求头中携带有效的JWT token
4. **超时处理**: 长时间无操作的会话会自动过期，需要重新创建
5. **数据缓存**: 评分数据会缓存一段时间，避免频繁计算

## 技术要求

- **前端**: 支持SSE、Promise/async-await、WebRTC(音频录制)
- **认证**: JWT Token认证
- **数据格式**: JSON
- **字符编码**: UTF-8